<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>余舍員工服務系統</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🏢</text></svg>">
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue";background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px}
  .container{max-width:1100px;margin:0 auto}
  .card{background:#fff;border-radius:16px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
  .header{color:#fff;text-align:center;margin-bottom:18px}
  .header h1{font-weight:600}
  .grid{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
  label{font-weight:600;margin-bottom:6px;display:block;color:#333}
  select,input,textarea{width:100%;border:2px solid #e1e5e9;border-radius:10px;padding:12px;font-size:16px}
  select:focus,input:focus,textarea:focus{outline:none;border-color:#667eea}
  .btn{display:inline-block;border:0;border-radius:10px;padding:12px 18px;font-weight:700;cursor:pointer}
  .btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
  .btn-ok{background:linear-gradient(135deg,#28a745,#20c997);color:#fff}
  .btn-grey{background:#6c757d;color:#fff}
  .alert{display:none;margin:12px 0;padding:12px;border-radius:10px;font-weight:700}
  .alert.show{display:block}
  .alert.success{background:rgba(40,167,69,.1);color:#2f8f46}
  .alert.error{background:rgba(220,53,69,.1);color:#b02a37}
  .stat{background:linear-gradient(135deg,#f7f9fc,#eef2f7);padding:14px;border-radius:12px;text-align:center}
  .stat .v{font-size:24px;font-weight:800;color:#667eea}
  .hidden{display:none}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>🏢 余舍員工服務系統</h1>
    <p>GitHub Pages + Google Apps Script</p>
  </div>

  <div class="card">
    <div id="sysAlert" class="alert"></div>
    <div class="grid">
      <div>
        <label for="employeeSelect">登入身份</label>
        <select id="employeeSelect"></select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnLogin" class="btn btn-primary">登入</button>
      </div>
    </div>
  </div>

  <div id="meCard" class="card hidden" style="margin-top:14px">
    <h3>📊 個人資訊</h3>
    <div id="me"></div>
    <div class="grid" style="margin-top:14px">
      <div class="stat"><div class="v" id="statTotal">0</div><div>總申請數</div></div>
      <div class="stat"><div class="v" id="statPending">0</div><div>待審核</div></div>
      <div class="stat"><div class="v" id="statApproved">0</div><div>已核准</div></div>
      <div class="stat"><div class="v" id="statAL">0</div><div>特休餘額(小時)</div></div>
    </div>
  </div>

  <div id="svcCard" class="card hidden" style="margin-top:14px">
    <h3>🛠️ 申請服務</h3>
    <div class="grid">
      <button class="btn btn-primary" onclick="openForm('leave')">請假申請</button>
      <button class="btn btn-primary" onclick="openForm('vacation')">特休/補休申請</button>
      <button class="btn btn-primary" onclick="openForm('schedule')">調班申請</button>
      <button class="btn btn-primary" onclick="openForm('overtime')">加班申請</button>
      <button class="btn btn-primary" onclick="openForm('clock')">補打卡申請</button>
      <button class="btn btn-primary" onclick="openForm('bonus')">房務獎金申請</button>
    </div>
  </div>

  <div id="formCard" class="card hidden" style="margin-top:14px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <h3 id="formTitle">表單</h3>
      <button class="btn btn-grey" onclick="closeForm()">關閉</button>
    </div>
    <form id="theForm">
      <div id="formBody"></div>
      <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:14px">
        <button type="button" class="btn btn-grey" onclick="closeForm()">取消</button>
        <button id="btnSubmit" class="btn btn-ok" type="submit">提交申請</button>
      </div>
    </form>
  </div>
</div>

<script>
  // ======== 設定 ========
  const API_URL = 'https://script.google.com/macros/s/AKfycbxSEW2gOsAkWYe81BQFNtE7cf6csRg1F2aitgO5YZqb26XCfyxqjMQUHvKXwEkSiPJ8/exec'; // ←改成你的 Web App URL
  const ORIGIN_HINT = location.origin; // 顯示用途
  // =====================

  const el = (id)=>document.getElementById(id);
  const qs = (s)=>document.querySelector(s);
  const state = { user:null, employees:[] };

  function alertBox(type,msg){
    const a = el('sysAlert');
    a.className = 'alert show ' + (type||'success');
    a.textContent = msg;
    setTimeout(()=>a.className='alert',4000);
  }

  async function api(method, payload){
    const opt = { method, headers: { 'Content-Type': 'application/json' } };
    if(method==='POST') opt.body = JSON.stringify(payload||{});
    const url = method==='GET'
      ? `${API_URL}?${new URLSearchParams(payload||{}).toString()}`
      : API_URL;
    const r = await fetch(url, opt);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const j = await r.json();
    if(!j.success) throw new Error(j.message||'failed');
    return j.data;
  }

  async function boot(){
    try{
      const data = await api('GET',{action:'listEmployees'});
      state.employees = data.employees||[];
      const sel = el('employeeSelect');
      sel.innerHTML = `<option value="">請選擇</option>` + state.employees.map(e=>(
        `<option value="${e.id}">${e.name}（${e.position}）</option>`
      )).join('');
    }catch(e){
      alertBox('error','讀取員工清單失敗');
    }
  }

  async function login(){
    const id = el('employeeSelect').value;
    if(!id) return alertBox('error','請選擇身份');
    try{
      const me = await api('POST',{ action:'login', employeeId:id });
      state.user = me;
      renderMe(me);
      el('meCard').classList.remove('hidden');
      el('svcCard').classList.remove('hidden');
      alertBox('success',`歡迎，${me.name}`);
    }catch(e){
      alertBox('error','登入失敗');
    }
  }

  function renderMe(me){
    el('me').innerHTML =
      `<p><b>姓名：</b>${me.name}</p>
       <p><b>員工編號：</b>${me.id}</p>
       <p><b>部門：</b>${me.department}</p>
       <p><b>職位：</b>${me.position}</p>
       <p><b>權限：</b>${me.authority}</p>`;
    el('statTotal').textContent = me.stats.total||0;
    el('statPending').textContent = me.stats.pending||0;
    el('statApproved').textContent = me.stats.approved||0;
    el('statAL').textContent = me.annualLeave||0;
  }

  const FORMS = {
    leave:{
      title:'🏖️ 請假申請',
      html:`
        <label>假別 *</label>
        <select name="leaveType" required>
          <option value="">請選擇</option>
          <option>事假</option><option>病假</option><option>婚假</option>
          <option>喪假</option><option>產假</option><option>陪產假</option>
          <option>家庭照顧假</option><option>生理假</option>
        </select>
        <div class="grid" style="margin-top:12px">
          <div><label>起始 *</label><input type="datetime-local" name="startDateTime" required></div>
          <div><label>結束 *</label><input type="datetime-local" name="endDateTime" required></div>
        </div>
        <div style="margin-top:12px">
          <label>事由 *</label>
          <textarea name="reason" required></textarea>
        </div>`
    },
    vacation:{
      title:'🌴 特休/補休申請',
      html:`
        <label>類型 *</label>
        <select name="vacationType" required>
          <option value="">請選擇</option><option>特休</option><option>補休</option>
        </select>
        <div class="grid" style="margin-top:12px">
          <div><label>起始 *</label><input type="datetime-local" name="startDateTime" required></div>
          <div><label>結束 *</label><input type="datetime-local" name="endDateTime" required></div>
        </div>
        <div class="grid" style="margin-top:12px">
          <div><label>申請時數 *</label><input type="number" name="requestedHours" step="0.5" min="0.5" required></div>
        </div>
        <div style="margin-top:12px">
          <label>事由 *</label>
          <textarea name="reason" required></textarea>
        </div>`
    },
    schedule:{
      title:'🔄 調班申請',
      html:`
        <div class="grid">
          <div><label>原日期 *</label><input type="date" name="originalDate" required></div>
          <div><label>原班別 *</label>
            <select name="originalShift" required>
              <option value="">請選擇</option>
              <option>早班 06:00-14:00</option><option>中班 14:00-22:00</option>
              <option>晚班 22:00-06:00</option><option>大夜班 00:00-08:00</option>
              <option>行政班 09:00-18:00</option>
            </select>
          </div>
        </div>
        <div class="grid" style="margin-top:12px">
          <div><label>新日期 *</label><input type="date" name="newDate" required></div>
          <div><label>新班別 *</label>
            <select name="newShift" required>
              <option value="">請選擇</option>
              <option>早班 06:00-14:00</option><option>中班 14:00-22:00</option>
              <option>晚班 22:00-06:00</option><option>大夜班 00:00-08:00</option>
              <option>行政班 09:00-18:00</option>
            </select>
          </div>
        </div>
        <div style="margin-top:12px">
          <label>事由 *</label><textarea name="reason" required></textarea>
        </div>`
    },
    overtime:{
      title:'⏰ 加班申請',
      html:`
        <div class="grid">
          <div><label>類型 *</label>
            <select name="overtimeType" required>
              <option value="">請選擇</option><option>平日加班</option><option>假日加班</option><option>國定假日加班</option>
            </select>
          </div>
          <div><label>處理方式 *</label>
            <select name="processMethod" required>
              <option value="">請選擇</option><option>補休</option><option>加班費</option>
            </select>
          </div>
        </div>
        <div class="grid" style="margin-top:12px">
          <div><label>起始 *</label><input type="datetime-local" name="startDateTime" required></div>
          <div><label>結束 *</label><input type="datetime-local" name="endDateTime" required></div>
        </div>
        <div class="grid" style="margin-top:12px">
          <div><label>加班時數 *</label><input type="number" name="overtimeHours" step="0.5" min="0.5" required></div>
        </div>
        <div style="margin-top:12px">
          <label>事由 *</label><textarea name="reason" required></textarea>
        </div>`
    },
    clock:{
      title:'🕐 補打卡申請',
      html:`
        <div class="grid">
          <div><label>日期 *</label><input type="date" name="clockDate" required></div>
          <div><label>時間 *</label><input type="time" name="clockTime" required></div>
        </div>
        <div class="grid" style="margin-top:12px">
          <div><label>類型 *</label>
            <select name="clockType" required>
              <option value="">請選擇</option><option>上班</option><option>下班</option><option>外出</option><option>返回</option>
            </select>
          </div>
        </div>
        <div style="margin-top:12px">
          <label>原因 *</label><textarea name="reason" required></textarea>
        </div>`
    },
    bonus:{
      title:'🏠 房務獎金申請',
      html:`
        <div class="grid">
          <div><label>預房日期 *</label><input type="date" name="bonusDate" required></div>
          <div><label>預房間數 *</label><input type="number" name="roomCount" min="0" required></div>
        </div>
        <div class="grid" style="margin-top:12px">
          <div><label>預房房號 *</label><input name="roomNumber" placeholder="例：101,102" required></div>
          <div><label>清潔間數 *</label><input type="number" name="cleanCount" min="0" required></div>
        </div>
        <div class="grid" style="margin-top:12px">
          <div><label>清潔房號 *</label><input name="cleanNumber" placeholder="例：201,202" required></div>
          <div><label>折扣間數</label><input type="number" name="discountCount" min="0"></div>
        </div>
        <div style="margin-top:12px">
          <label>折扣房號</label><input name="discountNumber" placeholder="例：301,302">
        </div>`
    }
  };

  function openForm(kind){
    if(!state.user){ alertBox('error','請先登入'); return; }
    el('formTitle').textContent = FORMS[kind].title;
    el('formBody').innerHTML = FORMS[kind].html + `<input type="hidden" name="__kind" value="${kind}">`;
    el('formCard').classList.remove('hidden');
    el('formCard').scrollIntoView({behavior:'smooth'});
  }
  function closeForm(){ el('theForm').reset(); el('formCard').classList.add('hidden'); }

  el('btnLogin').addEventListener('click', login);

  el('theForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!state.user) return alertBox('error','未登入');
    const fd = new FormData(e.target);
    const data = Object.fromEntries(fd.entries());
    const kind = data.__kind; delete data.__kind;
    const payload = { action:'submitApplication', applicationType:kind, submittedById:state.user.id, ...data };
    const btn = el('btnSubmit'); const t = btn.textContent; btn.disabled=true; btn.textContent='提交中…';
    try{
      const res = await api('POST', payload);
      alertBox('success', `已送出，編號：${res.applicationId}`);
      // 重新抓個人統計與餘額
      const me = await api('POST',{ action:'login', employeeId:state.user.id });
      state.user = me; renderMe(me);
      closeForm();
    }catch(err){
      alertBox('error', err.message||'提交失敗');
    }finally{
      btn.disabled=false; btn.textContent=t;
    }
  });

  boot();
</script>
</body>
</html>
