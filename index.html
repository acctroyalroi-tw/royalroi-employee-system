<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>余舍員工服務系統</title>
    <style>
        /* 保持原有的CSS樣式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 800px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #667eea;
        }

        h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1rem;
        }

        /* 登入區域樣式 */
        .login-section {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        select, input[type="password"], input[type="text"], input[type="datetime-local"], textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 用戶資訊區域 */
        .user-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .user-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detail-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .detail-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* 服務選項 */
        .services {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .service-card {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .service-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #667eea;
        }

        .service-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .service-desc {
            color: #666;
            font-size: 0.95rem;
        }

        /* 模態框樣式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        /* 特休申請特殊樣式 */
        .leave-balance-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .balance-card {
            background: #f0f8ff;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .balance-type {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .balance-hours {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-item input[type="radio"] {
            width: auto;
        }

        .warning-section, .error-section {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }

        .warning-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .error-section {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .success-message, .error-message {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .user-details {
                grid-template-columns: 1fr;
            }
            
            .services {
                grid-template-columns: 1fr;
            }
            
            .leave-balance-display {
                grid-template-columns: 1fr;
            }
        }

        /* 載入動畫 */
        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #667eea;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">🏨</div>
            <h1>余舍員工服務系統</h1>
            <p class="subtitle">Employee Service Portal</p>
        </div>

        <!-- 登入區域 -->
        <div id="loginSection" class="login-section">
            <h2 style="text-align: center; margin-bottom: 20px; color: #333;">員工登入</h2>
            
            <!-- 密碼登入 -->
            <div id="passwordLogin">
                <div class="form-group">
                    <label for="loginPassword">請輸入密碼：</label>
                    <input type="password" id="loginPassword" placeholder="輸入您的密碼">
                </div>
                <div style="text-align: center;">
                    <button class="btn" onclick="loginWithPassword()">登入</button>
                    <button class="btn" onclick="showFirstTimeLogin()" style="background: #6c757d;">首次登入</button>
                </div>
            </div>

            <!-- 首次登入 -->
            <div id="firstTimeLogin" style="display: none;">
                <div class="form-group">
                    <label for="employeeName">選擇您的姓名：</label>
                    <select id="employeeName">
                        <option value="">請選擇...</option>
                        <option value="廖述盛">廖述盛</option>
                        <option value="王彧疆">王彧疆</option>
                        <option value="陳家興">陳家興</option>
                        <option value="黃崑境">黃崑境</option>
                        <option value="徐志屹">徐志屹</option>
                        <option value="江孟庭">江孟庭</option>
                        <option value="蕭維宏">蕭維宏</option>
                        <option value="宋捷安">宋捷安</option>
                        <option value="陳紅秀">陳紅秀</option>
                        <option value="林家楙">林家楙</option>
                        <option value="楊丞勛">楊丞勛</option>
                        <option value="徐奕翔">徐奕翔</option>
                        <option value="柯宗男">柯宗男</option>
                        <option value="李維萍">李維萍</option>
                        <option value="許邦興">許邦興</option>
                        <option value="王文一">王文一</option>
                        <option value="羅紹文">羅紹文</option>
                        <option value="林奇緯">林奇緯</option>
                        <option value="柳佳璋">柳佳璋</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="employeeId">輸入員工編號：</label>
                    <input type="text" id="employeeId" placeholder="例如：A19104">
                </div>
                <div style="text-align: center;">
                    <button class="btn" onclick="verifyEmployee()">驗證身份</button>
                    <button class="btn" onclick="showPasswordLogin()" style="background: #6c757d;">返回</button>
                </div>
            </div>
        </div>

        <!-- 主要內容區域 -->
        <div id="mainContent" style="display: none;">
            <!-- 用戶資訊 -->
            <div class="user-info">
                <h2 id="welcomeMessage">歡迎回來！</h2>
                <div class="user-details">
                    <div class="detail-item">
                        <div class="detail-label">員工編號</div>
                        <div class="detail-value" id="userEmployeeId">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">部門</div>
                        <div class="detail-value" id="userDepartment">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">職位</div>
                        <div class="detail-value" id="userPosition">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">特休餘額</div>
                        <div class="detail-value" id="userAnnualLeave">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">補休餘額</div>
                        <div class="detail-value" id="userCompLeave">-</div>
                    </div>
                </div>
            </div>

            <!-- 服務選項 -->
            <div class="services">
                <div class="service-card" onclick="openForm('leave')">
                    <div class="service-icon">🏖️</div>
                    <div class="service-title">請假申請</div>
                    <div class="service-desc">提交各類請假申請</div>
                </div>
                
                <div class="service-card" onclick="openForm('overtime')">
                    <div class="service-icon">⏰</div>
                    <div class="service-title">加班申請</div>
                    <div class="service-desc">申請加班時數</div>
                </div>
                
                <div class="service-card" onclick="openForm('shift')">
                    <div class="service-icon">🔄</div>
                    <div class="service-title">調班申請</div>
                    <div class="service-desc">申請班別調整</div>
                </div>
                
                <div class="service-card" onclick="openForm('timecard')">
                    <div class="service-icon">⏱️</div>
                    <div class="service-title">補打卡申請</div>
                    <div class="service-desc">補登打卡記錄</div>
                </div>
                
                <div class="service-card" onclick="openForm('bonus')">
                    <div class="service-icon">💰</div>
                    <div class="service-title">房務獎金申請</div>
                    <div class="service-desc">申請房務相關獎金</div>
                </div>
                
                <div class="service-card" onclick="openLeaveBalance()">
                    <div class="service-icon">📊</div>
                    <div class="service-title">特休/補休申請</div>
                    <div class="service-desc">查看餘額並申請特休補休</div>
                </div>
            </div>

            <!-- 底部按鈕 -->
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="openRecordsModal()">📋 申請記錄</button>
                <button class="btn" onclick="showAdminPanel()">⚙️ 管理後台</button>
                <button class="btn" onclick="showHelp()">❓ 使用說明</button>
                <button class="btn" onclick="logout()" style="background: #dc3545;">🚪 登出</button>
            </div>
        </div>
    </div>

    <!-- 密碼設定模態框 -->
    <div id="passwordSetupModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('passwordSetupModal').style.display='none'">&times;</span>
            <h2>設定登入密碼</h2>
            <p>請為您的帳戶設定一個安全的密碼：</p>
            <div class="form-group">
                <label for="newPassword">新密碼（至少6個字元）：</label>
                <input type="password" id="newPassword" placeholder="輸入新密碼">
            </div>
            <div class="form-group">
                <label for="confirmPassword">確認密碼：</label>
                <input type="password" id="confirmPassword" placeholder="再次輸入密碼">
            </div>
            <div style="text-align: center;">
                <button class="btn" onclick="setupPassword()">設定密碼</button>
            </div>
        </div>
    </div>

    <!-- 申請記錄模態框 -->
    <div id="recordsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRecordsModal()">&times;</span>
            <h2>申請記錄</h2>
            <div id="recordsContent">
                <div class="loading">載入中...</div>
            </div>
        </div>
    </div>

    <!-- 特休/補休申請模態框 -->
    <div id="leaveBalanceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLeaveBalanceModal()">&times;</span>
            <h2>特休/補休申請</h2>
            
            <!-- 時數餘額顯示 -->
            <div class="leave-balance-display">
                <div class="balance-card">
                    <div class="balance-type">特休餘額</div>
                    <div class="balance-hours" id="modalAnnualBalance">-</div>
                    <div class="detail-label" id="modalAnnualDetail">可用時數</div>
                </div>
                <div class="balance-card">
                    <div class="balance-type">補休餘額</div>
                    <div class="balance-hours" id="modalCompBalance">-</div>
                    <div class="detail-label" id="modalCompDetail">可用時數</div>
                </div>
            </div>

            <!-- 申請表單 -->
            <form id="leaveBalanceForm">
                <div class="form-group">
                    <label>申請類型：</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="annualLeave" name="leaveType" value="annual" onchange="updateLeaveValidation()">
                            <label for="annualLeave">特休</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="compLeave" name="leaveType" value="comp" onchange="updateLeaveValidation()">
                            <label for="compLeave">補休</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="leaveStartDateTime">開始日期時間：</label>
                    <input type="datetime-local" id="leaveStartDateTime" onchange="calculateLeaveHours()">
                </div>

                <div class="form-group">
                    <label for="leaveEndDateTime">結束日期時間：</label>
                    <input type="datetime-local" id="leaveEndDateTime" onchange="calculateLeaveHours()">
                </div>

                <div class="form-group">
                    <label for="leaveHours">申請時數：</label>
                    <input type="number" id="leaveHours" step="0.5" min="0" readonly>
                </div>

                <div class="form-group">
                    <label for="leaveReason">申請事由：</label>
                    <textarea id="leaveReason" rows="3" placeholder="請說明申請原因..." oninput="updateLeaveValidation()"></textarea>
                </div>

                <!-- 警告和錯誤訊息 -->
                <div id="leaveWarningSection" class="warning-section">
                    <strong>⚠️ 注意：</strong>
                    <span id="leaveWarningText"></span>
                </div>

                <div id="leaveErrorSection" class="error-section">
                    <strong>❌ 錯誤：</strong>
                    <span id="leaveErrorText"></span>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" class="btn" id="leaveSubmitBtn" onclick="submitLeaveBalanceForm()" disabled>提交申請</button>
                    <button type="button" class="btn" onclick="closeLeaveBalanceModal()" style="background: #6c757d;">取消</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 全域變數
        let currentUser = null;

        // 員工資料
        const employeeData = {
            'A19001': { name: '廖述盛', department: '管理部', position: '總經理', permission: '管理員' },
            'A19051': { name: '王彧疆', department: '管理部', position: '經理', permission: '管理員' },
            'A19104': { name: '陳家興', department: '管理部', position: '管理部副理', permission: '主管' },
            'A19132': { name: '黃崑境', department: '客房部', position: '客房部副理', permission: '主管' },
            'A19147': { name: '徐志屹', department: '行銷業務部', position: '行銷業務主任', permission: '主管' },
            'A19107': { name: '江孟庭', department: '客房部', position: '客房部主任', permission: '主管' },
            'A19024': { name: '蕭維宏', department: '餐飲部', position: '餐飲部副理', permission: '主管' },
            'A19114': { name: '宋捷安', department: '工程部', position: '工程部主任', permission: '主管' },
            'A19133': { name: '陳紅秀', department: '客房部', position: '飯店管家', permission: '員工' },
            'A19145': { name: '林家楙', department: '客房部', position: '客房服務員', permission: '員工' },
            'A19149': { name: '楊丞勛', department: '餐飲部', position: '餐飲服務員', permission: '員工' },
            'A19152': { name: '徐奕翔', department: '餐飲部', position: '餐飲服務員', permission: '員工' },
            'A19140': { name: '柯宗男', department: '客房部', position: '客房服務員', permission: '員工' },
            'A19016': { name: '李維萍', department: '客房部', position: '客房清潔員', permission: '員工' },
            'A19065': { name: '許邦興', department: '工程部', position: '工程技術員', permission: '員工' },
            'A19146': { name: '王文一', department: '餐飲部', position: '廚師', permission: '員工' },
            'A19118': { name: '羅紹文', department: '餐飲部', position: '廚師助理', permission: '員工' },
            'A19136': { name: '林奇緯', department: '客房部', position: '客房服務員', permission: '員工' },
            'A19151': { name: '柳佳璋', department: '餐飲部', position: '餐飲服務員', permission: '員工' }
        };

        // 員工時數資料
        const employeeLeaveData = {
            'A19001': { name: '廖述盛', annual: 0, comp: 0 },
            'A19051': { name: '王彧疆', annual: 63, comp: 0 },
            'A19104': { name: '陳家興', annual: 61, comp: 0.5 },
            'A19132': { name: '黃崑境', annual: 70, comp: 0.5 },
            'A19147': { name: '徐志屹', annual: 11, comp: 0 },
            'A19107': { name: '江孟庭', annual: 119.5, comp: 0 },
            'A19024': { name: '蕭維宏', annual: 130.5, comp: 0 },
            'A19114': { name: '宋捷安', annual: 199, comp: 0.5 },
            'A19133': { name: '陳紅秀', annual: 62.5, comp: 0 },
            'A19145': { name: '林家楙', annual: 78.3, comp: 0 },
            'A19149': { name: '楊丞勛', annual: 0, comp: 0 },
            'A19152': { name: '徐奕翔', annual: 0, comp: 0 },
            'A19140': { name: '柯宗男', annual: 72, comp: 3.5 },
            'A19016': { name: '李維萍', annual: 125, comp: 5 },
            'A19065': { name: '許邦興', annual: 120, comp: 1 },
            'A19146': { name: '王文一', annual: 47.5, comp: 0 },
            'A19118': { name: '羅紹文', annual: 58.5, comp: 0 },
            'A19136': { name: '林奇緯', annual: 56, comp: 0 },
            'A19151': { name: '柳佳璋', annual: 0, comp: 0 }
        };

        // Google Apps Script Web App URL（需要替換為實際的URL）
        const WEBAPP_URL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';

        // 頁面初始化
        function initializePage() {
            checkExistingLogin();
        }

        // 檢查現有登入狀態
        function checkExistingLogin() {
            const savedPassword = localStorage.getItem('royalroi_employee_passwords');
            if (savedPassword) {
                const passwords = JSON.parse(savedPassword);
                // 如果有儲存的密碼，顯示密碼登入
                document.getElementById('loginPassword').focus();
            }
        }

        // 顯示首次登入
        function showFirstTimeLogin() {
            document.getElementById('passwordLogin').style.display = 'none';
            document.getElementById('firstTimeLogin').style.display = 'block';
        }

        // 顯示密碼登入
        function showPasswordLogin() {
            document.getElementById('firstTimeLogin').style.display = 'none';
            document.getElementById('passwordLogin').style.display = 'block';
        }

        // 密碼登入
        function loginWithPassword() {
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!password) {
                showError('❌ 請輸入密碼', '密碼不能為空。');
                return;
            }

            const savedPasswords = localStorage.getItem('royalroi_employee_passwords');
            if (!savedPasswords) {
                showError('❌ 找不到密碼', '請使用首次登入功能設定密碼。');
                return;
            }

            const passwords = JSON.parse(savedPasswords);
            const userEntry = Object.entries(passwords).find(([id, data]) => data.password === password);

            if (userEntry) {
                const [employeeId, userData] = userEntry;
                loginUser(employeeId);
                showSuccess('✅ 登入成功', `歡迎回來，${userData.name}！`);
            } else {
                showError('❌ 密碼錯誤', '請檢查您的密碼是否正確。');
            }
        }

        // 驗證員工身份
        function verifyEmployee() {
            const name = document.getElementById('employeeName').value;
            const id = document.getElementById('employeeId').value.trim();

            if (!name || !id) {
                showError('❌ 資料不完整', '請選擇姓名並輸入員工編號。');
                return;
            }

            const employee = employeeData[id];
            if (!employee || employee.name !== name) {
                showError('❌ 驗證失敗', '姓名與員工編號不符，請檢查後重新輸入。');
                return;
            }

            // 驗證成功，顯示密碼設定
            currentUser = { ...employee, id: id };
            document.getElementById('passwordSetupModal').style.display = 'block';
        }

        // 設定密碼
        function setupPassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!newPassword || newPassword.length < 6) {
                showError('❌ 密碼太短', '密碼至少需要6個字元。');
                return;
            }

            if (newPassword !== confirmPassword) {
                showError('❌ 密碼不一致', '兩次輸入的密碼不相同。');
                return;
            }

            // 儲存密碼
            let passwords = {};
            const savedPasswords = localStorage.getItem('royalroi_employee_passwords');
            if (savedPasswords) {
                passwords = JSON.parse(savedPasswords);
            }

            passwords[currentUser.id] = {
                name: currentUser.name,
                password: newPassword,
                setupDate: new Date().toISOString()
            };

            localStorage.setItem('royalroi_employee_passwords', JSON.stringify(passwords));

            // 關閉模態框並登入
            document.getElementById('passwordSetupModal').style.display = 'none';
            loginUser(currentUser.id);
            showSuccess('✅ 密碼設定成功', '您已成功登入系統！');
        }

        // 登入用戶
        function loginUser(employeeId) {
            const employee = employeeData[employeeId];
            const leaveData = employeeLeaveData[employeeId];

            currentUser = {
                ...employee,
                id: employeeId,
                annual: leaveData ? leaveData.annual : 0,
                comp: leaveData ? leaveData.comp : 0
            };

            // 隱藏登入區域，顯示主要內容
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';

            // 更新用戶資訊顯示
            updateUserDisplay();
        }

        // 更新用戶資訊顯示
        function updateUserDisplay() {
            document.getElementById('welcomeMessage').textContent = `歡迎回來，${currentUser.name}！`;
            document.getElementById('userEmployeeId').textContent = currentUser.id;
            document.getElementById('userDepartment').textContent = currentUser.department;
            document.getElementById('userPosition').textContent = currentUser.position;
            document.getElementById('userAnnualLeave').textContent = `${currentUser.annual} 小時`;
            document.getElementById('userCompLeave').textContent = `${currentUser.comp} 小時`;
        }

        // 登出
        function logout() {
            currentUser = null;
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('loginPassword').value = '';
            showSuccess('✅ 已登出', '您已成功登出系統。');
        }

        // 開啟申請記錄模態框
        function openRecordsModal() {
            if (!currentUser) {
                showError('❌ 未登入', '請先登入才能查看申請記錄。');
                return;
            }

            const modal = document.getElementById('recordsModal');
            const content = document.getElementById('recordsContent');
            
            modal.style.display = 'block';
            content.innerHTML = '<div class="loading">載入中...</div>';

            setTimeout(() => {
                displayApplicationRecords();
            }, 500);
        }

        // 顯示申請記錄
        function displayApplicationRecords() {
            const content = document.getElementById('recordsContent');
            
            // 新系統沒有任何申請記錄
            content.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">📋</div>
                    <h3>暫無申請記錄</h3>
                    <p>您還沒有任何申請記錄，可以開始提交申請。</p>
                </div>
            `;
        }

        // 關閉申請記錄模態框
        function closeRecordsModal() {
            document.getElementById('recordsModal').style.display = 'none';
        }

        // 開啟表單
        function openForm(formType) {
            if (!currentUser) {
                showError('❌ 未登入', '請先登入才能使用申請功能。');
                return;
            }

            const forms = {
                'leave': 'https://docs.google.com/forms/d/e/1FAIpQLScbDb0lZwndMEAX2ob73-qHS2v-Gtr1QfiS_7ltuNQk-RHByg/viewform',
                'overtime': 'https://docs.google.com/forms/d/e/1FAIpQLSfj-tHdGTISY8Js0ZWnuYzy-e6Sy6pKd0AfLwXcVHp1p80oOw/viewform',
                'shift': 'https://docs.google.com/forms/d/e/1FAIpQLSfLpIzs3ztNGPDPueFeXDDXYTQjGdRyuYCYcS72KDs09RiCKg/viewform',
                'timecard': 'https://docs.google.com/forms/d/e/1FAIpQLSeP8DfAmiq0u447SheKikQzcWlc5WUzWM6sSsNTAdoHMkpl7Q/viewform',
                'bonus': 'https://docs.google.com/forms/d/e/1FAIpQLSe7aNxZRxh5_yfaWHpt7ZhYK_zOcaJ8Jlf9KsowCcX39E0Zaw/viewform'
            };

            if (forms[formType]) {
                const url = new URL(forms[formType]);
                url.searchParams.set('usp', 'pp_url');
                url.searchParams.set('entry.2079065378', currentUser.name);
                url.searchParams.set('entry.214990621', currentUser.id);
                url.searchParams.set('entry.178532261', currentUser.department);
                url.searchParams.set('entry.295229815', currentUser.position);
                
                window.open(url.toString(), '_blank');
                showSuccess('✅ 表單已開啟', '您的基本資料已自動填入表單中。');
            } else {
                showError('❌ 表單錯誤', '找不到對應的表單連結。');
            }
        }

        // 開啟特休/補休申請
        function openLeaveBalance() {
            if (!currentUser) {
                showError('❌ 請先登入', '請先登入系統後再使用此功能。');
                return;
            }

            showLeaveBalanceModal();
        }

        // 顯示特休/補休申請模態框
        function showLeaveBalanceModal() {
            const modal = document.getElementById('leaveBalanceModal');
            modal.style.display = 'block';
            
            // 載入用戶時數資料
            loadUserLeaveBalance();
            
            // 重置表單
            document.getElementById('leaveBalanceForm').reset();
            document.getElementById('leaveSubmitBtn').disabled = true;
            document.getElementById('leaveWarningSection').style.display = 'none';
            document.getElementById('leaveErrorSection').style.display = 'none';
        }

        // 載入用戶時數餘額
        function loadUserLeaveBalance() {
            const leaveData = employeeLeaveData[currentUser.id];
            
            if (leaveData) {
                document.getElementById('modalAnnualBalance').textContent = `${leaveData.annual.toFixed(1)} 小時`;
                document.getElementById('modalAnnualDetail').textContent = `可用時數`;
                
                document.getElementById('modalCompBalance').textContent = `${leaveData.comp.toFixed(1)} 小時`;
                document.getElementById('modalCompDetail').textContent = `可用時數`;
            } else {
                document.getElementById('modalAnnualBalance').textContent = '0 小時';
                document.getElementById('modalAnnualDetail').textContent = '無資料';
                document.getElementById('modalCompBalance').textContent = '0 小時';
                document.getElementById('modalCompDetail').textContent = '無資料';
            }
        }

        // 計算請假時數
        function calculateLeaveHours() {
            const startDateTime = document.getElementById('leaveStartDateTime').value;
            const endDateTime = document.getElementById('leaveEndDateTime').value;
            
            if (startDateTime && endDateTime) {
                const start = new Date(startDateTime);
                const end = new Date(endDateTime);
                
                if (end > start) {
                    const diffMs = end - start;
                    const diffHours = diffMs / (1000 * 60 * 60);
                    document.getElementById('leaveHours').value = diffHours.toFixed(1);
                    updateLeaveValidation();
                } else {
                    document.getElementById('leaveHours').value = '';
                    showLeaveError('結束時間必須晚於開始時間');
                }
            }
        }

        // 更新請假驗證
        function updateLeaveValidation() {
            const leaveType = document.querySelector('input[name="leaveType"]:checked')?.value;
            const leaveHours = parseFloat(document.getElementById('leaveHours').value) || 0;
            const leaveReason = document.getElementById('leaveReason').value.trim();
            
            // 清除之前的警告和錯誤
            document.getElementById('leaveWarningSection').style.display = 'none';
            document.getElementById('leaveErrorSection').style.display = 'none';
            
            let canSubmit = false;
            
            if (leaveType && leaveHours > 0 && leaveReason) {
                const leaveData = employeeLeaveData[currentUser.id];
                
                if (leaveData) {
                    const availableHours = leaveType === 'annual' 
                        ? leaveData.annual
                        : leaveData.comp;
                    
                    if (leaveHours > availableHours) {
                        showLeaveError(`申請時數 ${leaveHours} 小時超過可用${leaveType === 'annual' ? '特休' : '補休'}時數 ${availableHours} 小時`);
                    } else if (leaveHours === availableHours) {
                        showLeaveWarning(`您將用完所有${leaveType === 'annual' ? '特休' : '補休'}時數`);
                        canSubmit = true;
                    } else {
                        canSubmit = true;
                    }
                } else {
                    showLeaveError('找不到您的時數資料，請聯繫管理員');
                }
            }
            
            document.getElementById('leaveSubmitBtn').disabled = !canSubmit;
        }

        // 顯示請假警告
        function showLeaveWarning(message) {
            document.getElementById('leaveWarningText').textContent = message;
            document.getElementById('leaveWarningSection').style.display = 'block';
        }

        // 顯示請假錯誤
        function showLeaveError(message) {
            document.getElementById('leaveErrorText').textContent = message;
            document.getElementById('leaveErrorSection').style.display = 'block';
        }

        // 提交特休/補休申請（修正版 - 直接提交）
        async function submitLeaveBalanceForm() {
            const leaveType = document.querySelector('input[name="leaveType"]:checked')?.value;
            const startDateTime = document.getElementById('leaveStartDateTime').value;
            const endDateTime = document.getElementById('leaveEndDateTime').value;
            const leaveHours = document.getElementById('leaveHours').value;
            const leaveReason = document.getElementById('leaveReason').value.trim();
            
            if (!leaveType || !startDateTime || !endDateTime || !leaveHours || !leaveReason) {
                showLeaveError('請填寫所有必填欄位');
                return;
            }
            
            // 準備申請資料
            const applicationData = {
                name: currentUser.name,
                empId: currentUser.id,
                department: currentUser.department,
                position: currentUser.position,
                leaveType: leaveType,
                startDateTime: startDateTime,
                endDateTime: endDateTime,
                hours: leaveHours,
                reason: leaveReason
            };
            
            // 顯示載入狀態
            const submitBtn = document.getElementById('leaveSubmitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '提交中...';
            submitBtn.disabled = true;
            
            try {
                // 調用Google Apps Script
                const response = await fetch(WEBAPP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'submitLeaveApplication',
                        data: applicationData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // 關閉模態框
                    closeLeaveBalanceModal();
                    
                    // 顯示成功訊息
                    showSuccess('✅ 申請提交成功', 
                        `您的${leaveType === 'annual' ? '特休' : '補休'}申請已成功提交！\n` +
                        `申請編號：${result.applicationId}\n` +
                        `提交時間：${result.timestamp}`
                    );
                    
                    // 更新用戶時數顯示（樂觀更新）
                    const leaveData = employeeLeaveData[currentUser.id];
                    if (leaveData) {
                        if (leaveType === 'annual') {
                            leaveData.annual -= parseFloat(leaveHours);
                            currentUser.annual = leaveData.annual;
                        } else {
                            leaveData.comp -= parseFloat(leaveHours);
                            currentUser.comp = leaveData.comp;
                        }
                        updateUserDisplay();
                    }
                    
                } else {
                    showLeaveError(result.message || '申請提交失敗，請稍後再試');
                }
                
            } catch (error) {
                console.error('提交申請失敗:', error);
                showLeaveError('網路連線錯誤，請檢查網路連線後再試');
            } finally {
                // 恢復按鈕狀態
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // 關閉特休/補休申請模態框
        function closeLeaveBalanceModal() {
            document.getElementById('leaveBalanceModal').style.display = 'none';
        }

        // 顯示管理後台
        function showAdminPanel() {
            if (!currentUser) {
                showError('❌ 請先登入', '請先登入系統後再使用此功能。');
                return;
            }

            if (currentUser.permission === '主管' || currentUser.permission === '管理員') {
                alert('管理後台功能開發中，敬請期待！');
            } else {
                showError('❌ 權限不足', '您沒有權限存取管理後台。');
            }
        }

        // 顯示幫助
        function showHelp() {
            alert(`
余舍員工服務系統使用說明：

👤 員工登入：
• 首次登入：選擇姓名 + 輸入員工編號 → 設定密碼
• 後續登入：直接輸入密碼即可

🔐 密碼功能：
• 首次登入後必須設定密碼
• 密碼至少6個字元，建議包含英文和數字
• 可在系統中修改密碼
• 忘記密碼請聯繫管理員

📋 系統功能：
• 查看個人資訊和統計數據
• 查看完整的申請歷史記錄
• 使用各種服務申請功能
• 特休/補休申請與時數查詢
• 安全的權限控制機制

🏖️ 特休/補休申請：
• 即時顯示可用時數餘額
• 自動計算申請時數
• 智能驗證防止超額申請
• 直接在系統內完成申請

如有問題請聯繫：acct.royalroi@gmail.com
            `);
        }

        // 顯示錯誤訊息
        function showError(title, message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<strong>${title}</strong><br>${message}`;
            
            const container = document.querySelector('.container');
            container.insertBefore(errorDiv, container.firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // 顯示成功訊息
        function showSuccess(title, message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.innerHTML = `<strong>${title}</strong><br>${message.replace(/\n/g, '<br>')}`;
            
            const container = document.querySelector('.container');
            container.insertBefore(successDiv, container.firstChild);
            
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
        }

        // 點擊模態框外部關閉
        window.onclick = function(event) {
            const recordsModal = document.getElementById('recordsModal');
            const leaveBalanceModal = document.getElementById('leaveBalanceModal');
            const passwordSetupModal = document.getElementById('passwordSetupModal');
            
            if (event.target === recordsModal) {
                closeRecordsModal();
            }
            if (event.target === leaveBalanceModal) {
                closeLeaveBalanceModal();
            }
            if (event.target === passwordSetupModal) {
                document.getElementById('passwordSetupModal').style.display = 'none';
            }
        }

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
