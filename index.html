<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ä½™èˆå“¡å·¥æœå‹™ç³»çµ±</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¢</text></svg>">
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue";background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px}
  .container{max-width:1100px;margin:0 auto}
  .card{background:#fff;border-radius:16px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
  .header{color:#fff;text-align:center;margin-bottom:18px}
  .header h1{font-weight:600}
  .grid{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
  label{font-weight:600;margin-bottom:6px;display:block;color:#333}
  select,input,textarea{width:100%;border:2px solid #e1e5e9;border-radius:10px;padding:12px;font-size:16px}
  select:focus,input:focus,textarea:focus{outline:none;border-color:#667eea}
  .btn{display:inline-block;border:0;border-radius:10px;padding:12px 18px;font-weight:700;cursor:pointer}
  .btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
  .btn-ok{background:linear-gradient(135deg,#28a745,#20c997);color:#fff}
  .btn-grey{background:#6c757d;color:#fff}
  .alert{display:none;margin:12px 0;padding:12px;border-radius:10px;font-weight:700}
  .alert.show{display:block}
  .alert.success{background:rgba(40,167,69,.1);color:#2f8f46}
  .alert.error{background:rgba(220,53,69,.1);color:#b02a37}
  .stat{background:linear-gradient(135deg,#f7f9fc,#eef2f7);padding:14px;border-radius:12px;text-align:center}
  .stat .v{font-size:24px;font-weight:800;color:#667eea}
  .hidden{display:none}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ¢ ä½™èˆå“¡å·¥æœå‹™ç³»çµ±</h1>
    <p>GitHub Pages + Google Apps Script</p>
  </div>

  <div class="card">
    <div id="sysAlert" class="alert"></div>
    <div class="grid">
      <div>
        <label for="employeeSelect">ç™»å…¥èº«ä»½</label>
        <select id="employeeSelect"></select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnLogin" class="btn btn-primary">ç™»å…¥</button>
      </div>
    </div>
  </div>

  <div id="meCard" class="card hidden" style="margin-top:14px">
    <h3>ğŸ“Š å€‹äººè³‡è¨Š</h3>
    <div id="me"></div>
    <div class="grid" style="margin-top:14px">
      <div class="stat"><div class="v" id="statTotal">0</div><div>ç¸½ç”³è«‹æ•¸</div></div>
      <div class="stat"><div class="v" id="statPending">0</div><div>å¾…å¯©æ ¸</div></div>
      <div class="stat"><div class="v" id="statApproved">0</div><div>å·²æ ¸å‡†</div></div>
      <div class="stat"><div class="v" id="statAL">0</div><div>ç‰¹ä¼‘é¤˜é¡(å°æ™‚)</div></div>
    </div>
  </div>

  <div id="svcCard" class="card hidden" style="margin-top:14px">
    <h3>ğŸ› ï¸ ç”³è«‹æœå‹™</h3>
    <div class="grid">
      <button class="btn btn-primary" onclick="openForm('leave')">è«‹å‡ç”³è«‹</button>
      <button class="btn btn-primary" onclick="openForm('vacation')">ç‰¹ä¼‘/è£œä¼‘ç”³è«‹</button>
      <button class="btn btn-primary" onclick="openForm('schedule')">èª¿ç­ç”³è«‹</button>
      <button class="btn btn-primary" onclick="openForm('overtime')">åŠ ç­ç”³è«‹</button>
      <button class="btn btn-primary" onclick="openForm('clock')">è£œæ‰“å¡ç”³è«‹</button>
      <button class="btn btn-primary" onclick="openForm('bonus')">æˆ¿å‹™çé‡‘ç”³è«‹</button>
    </div>
  </div>

  <div id="formCard" class="card hidden" style="margin-top:14px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <h3 id="formTitle">è¡¨å–®</h3>
      <button class="btn btn-grey" onclick="closeForm()">é—œé–‰</button>
    </div>
    <form id="theForm">
      <div id="formBody"></div>
      <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:14px">
        <button type="button" class="btn btn-grey" onclick="closeForm()">å–æ¶ˆ</button>
        <button id="btnSubmit" class="btn btn-ok" type="submit">æäº¤ç”³è«‹</button>
      </div>
    </form>
  </div>
</div>

<script>
  // ======== è¨­å®š ========
  const API_URL = 'https://script.google.com/macros/s/AKfycbxSEW2gOsAkWYe81BQFNtE7cf6csRg1F2aitgO5YZqb26XCfyxqjMQUHvKXwEkSiPJ8/exec'; // â†æ”¹æˆä½ çš„ Web App URL
  const ORIGIN_HINT = location.origin; // é¡¯ç¤ºç”¨é€”
  // =====================

  const el = (id)=>document.getElementById(id);
  const qs = (s)=>document.querySelector(s);
  const state = { user:null, employees:[] };

  function alertBox(type,msg){
    const a = el('sysAlert');
    a.className = 'alert show ' + (type||'success');
    a.textContent = msg;
    setTimeout(()=>a.className='alert',4000);
  }

  async function api(method, payload){
    const opt = { method, headers: { 'Content-Type': 'application/json' } };
    if(method==='POST') opt.body = JSON.stringify(payload||{});
    const url = method==='GET'
      ? `${API_URL}?${new URLSearchParams(payload||{}).toString()}`
      : API_URL;
    const r = await fetch(url, opt);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const j = await r.json();
    if(!j.success) throw new Error(j.message||'failed');
    return j.data;
  }

  async function boot(){
    try{
      const data = await api('GET',{action:'listEmployees'});
      state.employees = data.employees||[];
      const sel = el('employeeSelect');
      sel.innerHTML = `<option value="">è«‹é¸æ“‡</option>` + state.employees.map(e=>(
        `<option value="${e.id}">${e.name}ï¼ˆ${e.position}ï¼‰</option>`
      )).join('');
    }catch(e){
      alertBox('error','è®€å–å“¡å·¥æ¸…å–®å¤±æ•—');
    }
  }

  async function login(){
    const id = el('employeeSelect').value;
    if(!id) return alertBox('error','è«‹é¸æ“‡èº«ä»½');
    try{
      const me = await api('POST',{ action:'login', employeeId:id });
      state.user = me;
      renderMe(me);
      el('meCard').classList.remove('hidden');
      el('svcCard').classList.remove('hidden');
      alertBox('success',`æ­¡è¿ï¼Œ${me.name}`);
    }catch(e){
      alertBox('error','ç™»å…¥å¤±æ•—');
    }
  }

  function renderMe(me){
    el('me').innerHTML =
      `<p><b>å§“åï¼š</b>${me.name}</p>
       <p><b>å“¡å·¥ç·¨è™Ÿï¼š</b>${me.id}</p>
       <p><b>éƒ¨é–€ï¼š</b>${me.department}</p>
       <p><b>è·ä½ï¼š</b>${me.position}</p>
       <p><b>æ¬Šé™ï¼š</b>${me.authority}</p>`;
    el('statTotal').textContent = me.stats.total||0;
    el('statPending').textContent = me.stats.pending||0;
    el('statApproved').textContent = me.stats.approved||0;
    el('statAL').textContent = me.annualLeave||0;
  }

  const FORMS = {
    leave:{
      title:'ğŸ–ï¸ è«‹å‡ç”³è«‹',
      html:`
        <label>å‡åˆ¥ *</label>
        <select name="leaveType" required>
          <option value="">è«‹é¸æ“‡</option>
          <option>äº‹å‡</option><option>ç—…å‡</option><option>å©šå‡</option>
          <option>å–ªå‡</option><option>ç”¢å‡</option><option>é™ªç”¢å‡</option>
          <option>å®¶åº­ç…§é¡§å‡</option><option>ç”Ÿç†å‡</option>
        </select>
        <div class="grid" style="margin-top:12px">
          <div><label>èµ·å§‹ *</label><input type="datetime-local" name="startDateTime" required></div>
          <div><label>çµæŸ *</label><input type="datetime-local" name="endDateTime" required></div>
        </div>
        <div style="margin-top:12px">
          <label>äº‹ç”± *</label>
          <textarea name="reason" required></textarea>
        </div>`
    },
    vacation:{
      title:'ğŸŒ´ ç‰¹ä¼‘/è£œä¼‘ç”³è«‹',
      html:`
        <label>é¡å‹ *</label>
        <select name="vacationType" required>
          <option value="">è«‹é¸æ“‡</option><option>ç‰¹ä¼‘</option><option>è£œä¼‘</option>
        </select>
        <div class="grid" style="margin-top:12px">
          <div><label>èµ·å§‹ *</label><input type="datetime-local" name="startDateTime" required></div>
          <div><label>çµæŸ *</label><input type="datetime-local" name="endDateTime" required></div>
        </div>
        <div class="grid" style="margin-top:12px">
          <div><label>ç”³è«‹æ™‚æ•¸ *</label><input type="number" name="requestedHours" step="0.5" min="0.5" required></div>
        </div>
        <div style="margin-top:12px">
          <label>äº‹ç”± *</label>
          <textarea name="reason" required></textarea>
        </div>`
    },
    schedule:{
      title:'ğŸ”„ èª¿ç­ç”³è«‹',
      html:`
        <div class="grid">
          <div><label>åŸæ—¥æœŸ *</label><input type="date" name="originalDate" required></div>
          <div><label>åŸç­åˆ¥ *</label>
            <select name="originalShift" required>
              <option value="">è«‹é¸æ“‡</option>
              <option>æ—©ç­ 06:00-14:00</option><option>ä¸­ç­ 14:00-22:00</option>
              <option>æ™šç­ 22:00-06:00</option><option>å¤§å¤œç­ 00:00-08:00</option>
              <option>è¡Œæ”¿ç­ 09:00-18:00</option>
            </select>
          </div>
        </div>
        <div class="grid" style="margin-top:12px">
          <div><label>æ–°æ—¥æœŸ *</label><input type="date" name="newDate" required></div>
          <div><label>æ–°ç­åˆ¥ *</label>
            <select name="newShift" required>
              <option value="">è«‹é¸æ“‡</option>
              <option>æ—©ç­ 06:00-14:00</option><option>ä¸­ç­ 14:00-22:00</option>
              <option>æ™šç­ 22:00-06:00</option><option>å¤§å¤œç­ 00:00-08:00</option>
              <option>è¡Œæ”¿ç­ 09:00-18:00</option>
            </select>
          </div>
        </div>
        <div style="margin-top:12px">
          <label>äº‹ç”± *</label><textarea name="reason" required></textarea>
        </div>`
    },
    overtime:{
      title:'â° åŠ ç­ç”³è«‹',
      html:`
        <div class="grid">
          <div><label>é¡å‹ *</label>
            <select name="overtimeType" required>
              <option value="">è«‹é¸æ“‡</option><option>å¹³æ—¥åŠ ç­</option><option>å‡æ—¥åŠ ç­</option><option>åœ‹å®šå‡æ—¥åŠ ç­</option>
            </select>
          </div>
          <div><label>è™•ç†æ–¹å¼ *</label>
            <select name="processMethod" required>
              <option value="">è«‹é¸æ“‡</option><option>è£œä¼‘</option><option>åŠ ç­è²»</option>
            </select>
          </div>
        </div>
        <div class="grid" style="margin-top:12px">
          <div><label>èµ·å§‹ *</label><input type="datetime-local" name="startDateTime" required></div>
          <div><label>çµæŸ *</label><input type="datetime-local" name="endDateTime" required></div>
        </div>
        <div class="grid" style="margin-top:12px">
          <div><label>åŠ ç­æ™‚æ•¸ *</label><input type="number" name="overtimeHours" step="0.5" min="0.5" required></div>
        </div>
        <div style="margin-top:12px">
          <label>äº‹ç”± *</label><textarea name="reason" required></textarea>
        </div>`
    },
    clock:{
      title:'ğŸ• è£œæ‰“å¡ç”³è«‹',
      html:`
        <div class="grid">
          <div><label>æ—¥æœŸ *</label><input type="date" name="clockDate" required></div>
          <div><label>æ™‚é–“ *</label><input type="time" name="clockTime" required></div>
        </div>
        <div class="grid" style="margin-top:12px">
          <div><label>é¡å‹ *</label>
            <select name="clockType" required>
              <option value="">è«‹é¸æ“‡</option><option>ä¸Šç­</option><option>ä¸‹ç­</option><option>å¤–å‡º</option><option>è¿”å›</option>
            </select>
          </div>
        </div>
        <div style="margin-top:12px">
          <label>åŸå›  *</label><textarea name="reason" required></textarea>
        </div>`
    },
    bonus:{
      title:'ğŸ  æˆ¿å‹™çé‡‘ç”³è«‹',
      html:`
        <div class="grid">
          <div><label>é æˆ¿æ—¥æœŸ *</label><input type="date" name="bonusDate" required></div>
          <div><label>é æˆ¿é–“æ•¸ *</label><input type="number" name="roomCount" min="0" required></div>
        </div>
        <div class="grid" style="margin-top:12px">
          <div><label>é æˆ¿æˆ¿è™Ÿ *</label><input name="roomNumber" placeholder="ä¾‹ï¼š101,102" required></div>
          <div><label>æ¸…æ½”é–“æ•¸ *</label><input type="number" name="cleanCount" min="0" required></div>
        </div>
        <div class="grid" style="margin-top:12px">
          <div><label>æ¸…æ½”æˆ¿è™Ÿ *</label><input name="cleanNumber" placeholder="ä¾‹ï¼š201,202" required></div>
          <div><label>æŠ˜æ‰£é–“æ•¸</label><input type="number" name="discountCount" min="0"></div>
        </div>
        <div style="margin-top:12px">
          <label>æŠ˜æ‰£æˆ¿è™Ÿ</label><input name="discountNumber" placeholder="ä¾‹ï¼š301,302">
        </div>`
    }
  };

  function openForm(kind){
    if(!state.user){ alertBox('error','è«‹å…ˆç™»å…¥'); return; }
    el('formTitle').textContent = FORMS[kind].title;
    el('formBody').innerHTML = FORMS[kind].html + `<input type="hidden" name="__kind" value="${kind}">`;
    el('formCard').classList.remove('hidden');
    el('formCard').scrollIntoView({behavior:'smooth'});
  }
  function closeForm(){ el('theForm').reset(); el('formCard').classList.add('hidden'); }

  el('btnLogin').addEventListener('click', login);

  el('theForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!state.user) return alertBox('error','æœªç™»å…¥');
    const fd = new FormData(e.target);
    const data = Object.fromEntries(fd.entries());
    const kind = data.__kind; delete data.__kind;
    const payload = { action:'submitApplication', applicationType:kind, submittedById:state.user.id, ...data };
    const btn = el('btnSubmit'); const t = btn.textContent; btn.disabled=true; btn.textContent='æäº¤ä¸­â€¦';
    try{
      const res = await api('POST', payload);
      alertBox('success', `å·²é€å‡ºï¼Œç·¨è™Ÿï¼š${res.applicationId}`);
      // é‡æ–°æŠ“å€‹äººçµ±è¨ˆèˆ‡é¤˜é¡
      const me = await api('POST',{ action:'login', employeeId:state.user.id });
      state.user = me; renderMe(me);
      closeForm();
    }catch(err){
      alertBox('error', err.message||'æäº¤å¤±æ•—');
    }finally{
      btn.disabled=false; btn.textContent=t;
    }
  });

  boot();
</script>
</body>
</html>
